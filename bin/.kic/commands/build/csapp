#!/bin/bash

#name: imdb
#short: Build and deploy the IMDb reference app to the local cluster

# change to this directory
#cd "$(dirname "${BASH_SOURCE[0]}")" || exit

# validate directories
if [ ! -d ./deploy ]; then echo "./deploy directory not found. Please cd to an appropriate directory"; exit 1; fi
if [ ! -d ./deploy/csapp ]; then echo "./deploy/csapp directory not found. Please cd to an appropriate directory"; exit 1; fi

# delete webv and imdb
kubectl delete -f deploy/webv --ignore-not-found=true
kubectl delete -f deploy/csapp --ignore-not-found=true

# build and push the local image
docker build . -t k3d-registry.localhost:5500/csapp:local
docker push k3d-registry.localhost:5500/csapp:local

# wait for delete to finish
kubectl wait pod -l app=webv -n csapp --for delete --timeout=30s
kubectl wait pod -l app=csapp -n csapp --for delete --timeout=30s

# deploy local app and re-deploy webv
kubectl apply -f deploy/csapp
kubectl wait pod -l app=csapp -n csapp --for condition=ready --timeout=30s
kubectl apply -f deploy/webv
kubectl wait pod -l app=webv -n csapp --for condition=ready --timeout=30s

# show status and curl results
kubectl get po -n csapp
http localhost:30080/version
